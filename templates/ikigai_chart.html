{% extends "base.html" %}

{% block title %}Your Ikigai Chart - Ikigai Pathway{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .venn-diagram {
        width: 100%;
        height: auto;
    }
    
    .empty-chart-message {
        text-align: center;
        padding: 3rem;
        background-color: rgba(246, 206, 206, 0.1);
        border-radius: 8px;
        margin: 2rem 0;
    }
    
    .chart-actions {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
        gap: 1rem;
    }
    
    .growth-tips {
        margin-top: 3rem;
        padding: 2rem;
        background-color: rgba(123, 161, 125, 0.1);
        border-radius: 8px;
    }
    
    .tip-item {
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #fff;
        border-left: 4px solid #7BA17D;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .download-options {
        display: none;
        position: absolute;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 1rem;
        z-index: 100;
        top: 100%;
        right: 0;
    }
    
    .download-options.active {
        display: block;
    }
    
    .download-option {
        display: block;
        padding: 0.5rem 1rem;
        text-decoration: none;
        color: #2A2A2A;
        transition: background-color 0.2s;
    }
    
    .download-option:hover {
        background-color: #f5f5f5;
    }
</style>
{% endblock %}

{% block content %}
<section class="chart-hero">
    <div class="container">
        <h1>Your Ikigai Chart</h1>
        <p class="subtitle">The intersection of passion, mission, vocation, and profession</p>
    </div>
</section>

<section class="ikigai-chart-section">
    <div class="container">
        {% if user_data and user_data.passion and user_data.mission and user_data.vocation and user_data.profession %}
            <div class="chart-container">
                <canvas id="ikigaiChart"></canvas>
                
                <div class="chart-actions">
                    <button id="downloadBtn" class="btn-primary">Download Chart</button>
                    <div class="download-options" id="downloadOptions">
                        <a href="#" class="download-option" data-format="png">PNG Image</a>
                        <a href="#" class="download-option" data-format="pdf">PDF Document</a>
                    </div>
                </div>
            </div>
            
            <div class="growth-tips">
                <h2>Your Workplace Growth Tips</h2>
                <p>Based on your ikigai profile, here are personalized tips to help you thrive professionally:</p>
                
                <div id="tipsList" class="tips-list">
                    <div class="loading-tips">
                        <p>Generating your personalized tips...</p>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="empty-chart-message">
                <h2>Your Ikigai Chart is Waiting to be Created</h2>
                <p>Complete the four pillars of ikigai to generate your personalized chart and workplace growth tips.</p>
                <a href="{{ url_for('pillar', pillar_name='passion') }}" class="btn-primary">Begin Your Journey</a>
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if user_data and user_data.passion and user_data.mission and user_data.vocation and user_data.profession %}
            // Prepare data for the chart
            const userData = {{ user_data|tojson }};
            
            // Create the Venn diagram
            const ctx = document.getElementById('ikigaiChart').getContext('2d');
            
            // This is a simplified representation - in a real implementation,
            // you would use a proper Venn diagram library or create a custom visualization
            // Here we're using Chart.js to create a placeholder
            
            const chart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [
                        {
                            label: 'Passion',
                            data: [{x: 200, y: 200, r: 100}],
                            backgroundColor: 'rgba(246, 206, 206, 0.6)',
                        },
                        {
                            label: 'Mission',
                            data: [{x: 300, y: 200, r: 100}],
                            backgroundColor: 'rgba(123, 161, 125, 0.6)',
                        },
                        {
                            label: 'Vocation',
                            data: [{x: 200, y: 300, r: 100}],
                            backgroundColor: 'rgba(63, 75, 131, 0.6)',
                        },
                        {
                            label: 'Profession',
                            data: [{x: 300, y: 300, r: 100}],
                            backgroundColor: 'rgba(212, 175, 55, 0.6)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    let items = [];
                                    
                                    switch(label) {
                                        case 'Passion':
                                            items = userData.passion.map(item => item.answer);
                                            break;
                                        case 'Mission':
                                            items = userData.mission.map(item => item.answer);
                                            break;
                                        case 'Vocation':
                                            items = userData.vocation.map(item => item.answer);
                                            break;
                                        case 'Profession':
                                            items = userData.profession.map(item => item.answer);
                                            break;
                                    }
                                    
                                    return [label, ...items];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false,
                            min: 0,
                            max: 500
                        },
                        y: {
                            display: false,
                            min: 0,
                            max: 500
                        }
                    }
                }
            });
            
            // Download functionality
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadOptions = document.getElementById('downloadOptions');
            
            downloadBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                downloadOptions.classList.toggle('active');
            });
            
            document.addEventListener('click', function(e) {
                if (!downloadOptions.contains(e.target) && e.target !== downloadBtn) {
                    downloadOptions.classList.remove('active');
                }
            });
            
            const downloadLinks = document.querySelectorAll('.download-option');
            downloadLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const format = this.dataset.format;
                    
                    if (format === 'png') {
                        // Download as PNG
                        const link = document.createElement('a');
                        link.download = 'ikigai-chart.png';
                        link.href = document.getElementById('ikigaiChart').toDataURL('image/png');
                        link.click();
                    } else if (format === 'pdf') {
                        // Download as PDF
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        
                        // Add title
                        doc.setFontSize(18);
                        doc.text('Your Ikigai Chart', 105, 15, { align: 'center' });
                        
                        // Add chart image
                        const chartImg = document.getElementById('ikigaiChart').toDataURL('image/png');
                        doc.addImage(chartImg, 'PNG', 20, 30, 170, 100);
                        
                        // Add sections
                        doc.setFontSize(14);
                        doc.text('Your Ikigai Elements', 20, 150);
                        
                        doc.setFontSize(12);
                        let yPos = 160;
                        
                        // Passion
                        doc.setTextColor(246, 206, 206);
                        doc.text('Passion (What You Love):', 20, yPos);
                        doc.setTextColor(0, 0, 0);
                        yPos += 7;
                        userData.passion.forEach(item => {
                            doc.text('• ' + item.answer, 25, yPos);
                            yPos += 7;
                        });
                        
                        yPos += 5;
                        
                        // Mission
                        doc.setTextColor(123, 161, 125);
                        doc.text('Mission (What the World Needs):', 20, yPos);
                        doc.setTextColor(0, 0, 0);
                        yPos += 7;
                        userData.mission.forEach(item => {
                            doc.text('• ' + item.answer, 25, yPos);
                            yPos += 7;
                        });
                        
                        yPos += 5;
                        
                        // Vocation
                        doc.setTextColor(63, 75, 131);
                        doc.text('Vocation (What You Are Good At):', 20, yPos);
                        doc.setTextColor(0, 0, 0);
                        yPos += 7;
                        userData.vocation.forEach(item => {
                            doc.text('• ' + item.answer, 25, yPos);
                            yPos += 7;
                        });
                        
                        yPos += 5;
                        
                        // Profession
                        doc.setTextColor(212, 175, 55);
                        doc.text('Profession (What You Can Be Paid For):', 20, yPos);
                        doc.setTextColor(0, 0, 0);
                        yPos += 7;
                        userData.profession.forEach(item => {
                            doc.text('• ' + item.answer, 25, yPos);
                            yPos += 7;
                        });
                        
                        doc.save('ikigai-chart.pdf');
                    }
                    
                    downloadOptions.classList.remove('active');
                });
            });
            
            // Fetch growth tips
            fetch('/api/growth_tips', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ikigai_data: userData
                }),
            })
            .then(response => response.json())
            .then(data => {
                const tipsList = document.getElementById('tipsList');
                tipsList.innerHTML = '';
                
                if (data.tips && data.tips.length > 0) {
                    data.tips.forEach((tip, index) => {
                        const tipItem = document.createElement('div');
                        tipItem.className = 'tip-item';
                        tipItem.innerHTML = `
                            <h3>Tip ${index + 1}</h3>
                            <p>${tip}</p>
                        `;
                        tipsList.appendChild(tipItem);
                    });
                } else {
                    tipsList.innerHTML = '<p>No tips available at this time.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching growth tips:', error);
                document.getElementById('tipsList').innerHTML = '<p>Unable to load growth tips. Please try again later.</p>';
            });
        {% endif %}
    });
</script>
{% endblock %}
