{% extends "base.html" %}

{% block title %}{{ pillar|capitalize }} - Ikigai Pathway{% endblock %}

{% block content %}
<section class="pillar-hero {{ pillar }}-hero">
    <div class="container">
        <h1>Explore Your {{ pillar|capitalize }}</h1>
        {% if pillar == 'passion' %}
        <p class="subtitle">What You Love</p>
        {% elif pillar == 'mission' %}
        <p class="subtitle">What the World Needs</p>
        {% elif pillar == 'vocation' %}
        <p class="subtitle">What You Are Good At</p>
        {% elif pillar == 'profession' %}
        <p class="subtitle">What You Can Be Paid For</p>
        {% endif %}
    </div>
</section>

<section class="pillar-questions">
    <div class="container">
        <div class="question-module">
            <form id="pillarForm">
                <input type="hidden" id="pillarType" value="{{ pillar }}">
                
                {% if pillar == 'passion' %}
                <div class="question-block">
                    <h3>What activities make you lose track of time?</h3>
                    <p class="question-description">Think about moments when you were so engaged that hours passed without you noticing.</p>
                    <div class="answers-container" data-question="1">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                <div class="question-block">
                    <h3>What topics do you enjoy learning about?</h3>
                    <p class="question-description">Consider subjects that naturally capture your interest and curiosity.</p>
                    <div class="answers-container" data-question="2">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                <div class="question-block">
                    <h3>What would you do even if you weren't paid for it?</h3>
                    <p class="question-description">Identify activities you find intrinsically rewarding, regardless of compensation.</p>
                    <div class="answers-container" data-question="3">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                {% elif pillar == 'mission' %}
                <div class="question-block">
                    <h3>What problems in the world do you feel drawn to solve?</h3>
                    <p class="question-description">Consider issues that you feel emotionally connected to or concerned about.</p>
                    <div class="answers-container" data-question="1">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                <div class="question-block">
                    <h3>How would you like to contribute to your community or society?</h3>
                    <p class="question-description">Think about the positive impact you'd like to make in the lives of others.</p>
                    <div class="answers-container" data-question="2">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                <div class="question-block">
                    <h3>What changes would you like to see in the world?</h3>
                    <p class="question-description">Envision how the world could be better and what role you might play.</p>
                    <div class="answers-container" data-question="3">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                {% elif pillar == 'vocation' %}
                <div class="question-block">
                    <h3>What skills come naturally to you?</h3>
                    <p class="question-description">Consider abilities that you've always had a knack for, even without formal training.</p>
                    <div class="answers-container" data-question="1">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                <div class="question-block">
                    <h3>What do others recognize you for being good at?</h3>
                    <p class="question-description">Think about compliments you receive or tasks people often ask for your help with.</p>
                    <div class="answers-container" data-question="2">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                <div class="question-block">
                    <h3>What skills have you developed through education or experience?</h3>
                    <p class="question-description">Consider abilities you've cultivated through deliberate practice or study.</p>
                    <div class="answers-container" data-question="3">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                {% elif pillar == 'profession' %}
                <div class="question-block">
                    <h3>What services or skills do people value enough to pay for?</h3>
                    <p class="question-description">Consider what you offer that meets a market demand.</p>
                    <div class="answers-container" data-question="1">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                <div class="question-block">
                    <h3>What work environments or industries appeal to you?</h3>
                    <p class="question-description">Think about where you'd thrive professionally based on culture, pace, and focus.</p>
                    <div class="answers-container" data-question="2">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                
                <div class="question-block">
                    <h3>What career paths align with your values and lifestyle goals?</h3>
                    <p class="question-description">Consider how different professions would support the life you want to lead.</p>
                    <div class="answers-container" data-question="3">
                        <div class="answer-input-container">
                            <input type="text" class="answer-input" placeholder="Enter your answer...">
                            <div class="suggestions-container"></div>
                        </div>
                        <button type="button" class="add-answer-btn">+ Add Another Answer</button>
                    </div>
                </div>
                {% endif %}
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save & Continue</button>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add answer functionality
        const addAnswerButtons = document.querySelectorAll('.add-answer-btn');
        addAnswerButtons.forEach(button => {
            button.addEventListener('click', function() {
                const answersContainer = this.parentElement;
                const newInputContainer = document.createElement('div');
                newInputContainer.className = 'answer-input-container';
                newInputContainer.innerHTML = `
                    <input type="text" class="answer-input" placeholder="Enter your answer...">
                    <button type="button" class="remove-answer-btn">Ã—</button>
                    <div class="suggestions-container"></div>
                `;
                
                // Insert before the add button
                answersContainer.insertBefore(newInputContainer, this);
                
                // Add event listener for the new input
                setupInputListeners(newInputContainer.querySelector('.answer-input'));
            });
        });
        
        // Remove answer functionality (delegated)
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-answer-btn')) {
                e.target.parentElement.remove();
            }
        });
        
        // Setup input listeners for AI suggestions
        function setupInputListeners(input) {
            let typingTimer;
            const doneTypingInterval = 500;
            
            input.addEventListener('input', function() {
                clearTimeout(typingTimer);
                
                const suggestionsContainer = this.nextElementSibling.classList.contains('suggestions-container') 
                    ? this.nextElementSibling 
                    : this.parentElement.querySelector('.suggestions-container');
                
                if (this.value.length < 3) {
                    suggestionsContainer.innerHTML = '';
                    return;
                }
                
                typingTimer = setTimeout(() => {
                    const pillar = document.getElementById('pillarType').value;
                    
                    fetch('/api/suggestions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: this.value,
                            pillar: pillar
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        suggestionsContainer.innerHTML = '';
                        
                        if (data.suggestions && data.suggestions.length > 0) {
                            data.suggestions.forEach(suggestion => {
                                const suggestionEl = document.createElement('div');
                                suggestionEl.className = 'suggestion';
                                suggestionEl.textContent = suggestion;
                                suggestionEl.addEventListener('click', () => {
                                    this.value = suggestion;
                                    suggestionsContainer.innerHTML = '';
                                });
                                suggestionsContainer.appendChild(suggestionEl);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error getting suggestions:', error);
                    });
                }, doneTypingInterval);
            });
        }
        
        // Setup initial input listeners
        document.querySelectorAll('.answer-input').forEach(input => {
            setupInputListeners(input);
        });
        
        // Form submission
        const pillarForm = document.getElementById('pillarForm');
        pillarForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const pillar = document.getElementById('pillarType').value;
            const answersContainers = document.querySelectorAll('.answers-container');
            
            let allAnswers = [];
            
            answersContainers.forEach(container => {
                const questionNumber = container.dataset.question;
                const inputs = container.querySelectorAll('.answer-input');
                
                inputs.forEach(input => {
                    if (input.value.trim()) {
                        allAnswers.push({
                            question: questionNumber,
                            answer: input.value.trim()
                        });
                    }
                });
            });
            
            if (allAnswers.length === 0) {
                alert('Please provide at least one answer before continuing.');
                return;
            }
            
            fetch('/save_pillar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pillar: pillar,
                    answers: allAnswers
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Determine next pillar or go to chart
                    let nextPage;
                    
                    switch(pillar) {
                        case 'passion':
                            nextPage = '/pillar/mission';
                            break;
                        case 'mission':
                            nextPage = '/pillar/vocation';
                            break;
                        case 'vocation':
                            nextPage = '/pillar/profession';
                            break;
                        case 'profession':
                            nextPage = '/ikigai_chart';
                            break;
                        default:
                            nextPage = '/';
                    }
                    
                    window.location.href = nextPage;
                } else {
                    alert(data.message || 'There was an error saving your answers. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error saving pillar data:', error);
                alert('There was an error saving your answers. Please try again.');
            });
        });
    });
</script>
{% endblock %}
